<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Panel | Sequ√≠a Monitor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#020617; --bg2:#0b1120; --card:#020617; --fg:#e5e7eb; --muted:#9ca3af;
      --stroke:#1f2937; --accent:#22c55e; --accent2:#16a34a; --blue:#3b82f6; --amber:#f59e0b; --red:#ef4444;
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg:#e5ecf8; --bg2:#d6e2fb; --card:#ffffff; --fg:#020617; --muted:#4b5563; --stroke:#d1d5db;
      }
    }
    *{box-sizing:border-box; margin:0; padding:0}
    body{
      min-height:100vh;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter,sans-serif;
      background:
        radial-gradient(1200px 600px at 0% 0%, #1d355780 0%, transparent 55%),
        radial-gradient(900px 500px at 100% 100%, #0b132633 0%, transparent 60%),
        linear-gradient(180deg, var(--bg), var(--bg2));
      color:var(--fg);
      padding:16px;
    }
    .layout{
      max-width:1200px;
      margin:0 auto;
    }
    header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:16px;
      margin-bottom:16px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .brand h1{font-size:20px}
    .badge{
      font-size:11px;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid #22c55e55;
      color:#bbf7d0;
      background:#16a34a33;
    }
    @media (prefers-color-scheme: light){
      .badge{color:#166534; background:#bbf7d0}
    }

    .user-info{font-size:13px; color:var(--muted); text-align:right}
    .user-info a{color:var(--blue); text-decoration:none}

    .grid{
      display:grid;
      grid-template-columns:2.1fr 1.2fr;
      gap:16px;
    }
    @media (max-width:960px){
      .grid{grid-template-columns:1fr}
    }

    .card{
      background:radial-gradient(circle at top left,#1d283a99,transparent 60%);
      border-radius:18px;
      border:1px solid var(--stroke);
      padding:16px 16px 18px;
      box-shadow:0 18px 40px #00000055;
    }
    @media (prefers-color-scheme: light){
      .card{
        background:var(--card);
        box-shadow:0 8px 20px #00000011;
      }
    }
    .card h2{
      font-size:16px;
      margin-bottom:8px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .card h2 span.icon{
      width:22px; height:22px; border-radius:999px;
      display:grid; place-items:center;
      background:#22c55e22;
    }
    .card small{color:var(--muted); font-size:12px}

    .stats{
      display:grid;
      grid-template-columns:repeat(4,minmax(0,1fr));
      gap:10px;
      margin-top:10px;
    }
    @media (max-width:900px){
      .stats{grid-template-columns:repeat(2,minmax(0,1fr))}
    }
    .stat{
      padding:10px;
      border-radius:12px;
      border:1px solid var(--stroke);
      background:#020617aa;
      font-size:12px;
    }
    @media (prefers-color-scheme: light){
      .stat{background:#f9fafb}
    }
    .stat-label{color:var(--muted); margin-bottom:2px}
    .stat-value{font-size:18px; font-weight:700}
    .stat-pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      border-radius:999px;
      padding:2px 8px;
      font-size:11px;
      margin-top:4px;
    }

    .pill-green{background:#16a34a22; color:#bbf7d0}
    .pill-blue{background:#1d4ed822; color:#bfdbfe}
    .pill-amber{background:#f59e0b22; color:#fed7aa}

    @media (prefers-color-scheme: light){
      .pill-green{background:#dcfce7; color:#166534}
      .pill-blue{background:#dbeafe; color:#1d4ed8}
      .pill-amber{background:#fef3c7; color:#92400e}
    }

    .tables{
      display:grid;
      grid-template-columns: minmax(0,1.2fr) minmax(0,1.2fr);
      gap:12px;
      margin-top:14px;
    }
    @media (max-width:900px){
      .tables{grid-template-columns:1fr}
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:12px;
      margin-top:6px;
    }
    th,td{
      padding:6px 4px;
      border-bottom:1px solid #1f2937;
    }
    th{ text-align:left; color:var(--muted); font-weight:500; font-size:11px}
    tr:last-child td{border-bottom:none}
    tr:nth-child(even){background:#02061755}
    @media (prefers-color-scheme: light){
      tr:nth-child(even){background:#f9fafb}
      th,td{border-bottom:1px solid #e5e7eb}
    }

    .tag{
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:2px 7px;
      border-radius:999px;
      font-size:11px;
      background:#1e293b;
      color:#e5e7eb;
    }
    @media (prefers-color-scheme: light){
      .tag{background:#e5ecf8; color:#111827}
    }

    /* Tarjeta clima */
    .clima-card{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .clima-main{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .clima-temp{
      font-size:32px;
      font-weight:700;
    }
    .clima-meta{font-size:12px; color:var(--muted)}
    .clima-grid{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:6px;
      font-size:12px;
      margin-top:6px;
    }
    .clima-chip{
      border-radius:999px;
      border:1px solid var(--stroke);
      padding:4px 8px;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }

    form.clima-form{
      display:flex;
      gap:6px;
      margin-top:4px;
      font-size:12px;
    }
    form.clima-form input{
      flex:1;
      border-radius:999px;
      border:1px solid var(--stroke);
      padding:6px 8px;
      background:#020617aa;
      color:var(--fg);
      outline:none;
    }
    form.clima-form button{
      border-radius:999px;
      border:none;
      padding:6px 10px;
      cursor:pointer;
      font-size:12px;
      font-weight:600;
      background:linear-gradient(135deg,#22c55e,#16a34a);
      color:white;
    }

    .alert{
      margin-top:6px;
      font-size:12px;
      padding:6px 8px;
      border-radius:8px;
      border:1px solid #f97316;
      background:#f973161a;
      color:#fed7aa;
    }
    @media (prefers-color-scheme: light){
      .alert{background:#fffbeb; color:#92400e; border-color:#fbbf24}
    }
  </style>
</head>
<body>
  <div class="layout">
    <header>
      <div class="brand">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="#22c55e" aria-hidden="true">
          <path d="M12 2c3 4 7 8 7 12a7 7 0 1 1-14 0c0-4 4-8 7-12z"/>
        </svg>
        <div>
          <h1>Panel Sequ√≠a Monitor</h1>
          <div class="badge">Autenticado ¬∑ Control de medidas e indicadores</div>
        </div>
      </div>
      <div class="user-info">
        <div>Usuario: <strong>{{ request.user.username }}</strong></div>
        <div>
          <a href="{% url 'logout' %}">Cerrar sesi√≥n</a> ¬∑
          <a href="/admin/">Django admin</a>
        </div>
      </div>
    </header>

    <div class="grid">
      <!-- Columna izquierda: resumen + tablas -->
      <section class="card">
        <h2>
          <span class="icon">üìä</span>
          Resumen de proyecto
        </h2>
        <small>Medidas, fuentes, indicadores y avance promedio.</small>

        <div class="stats">
          <div class="stat">
            <div class="stat-label">Medidas</div>
            <div class="stat-value">{{ resumen.total_medidas }}</div>
            <div class="stat-pill pill-green">
              ‚úì Acciones contra la sequ√≠a
            </div>
          </div>
          <div class="stat">
            <div class="stat-label">Indicadores</div>
            <div class="stat-value">{{ resumen.total_indicadores }}</div>
            <div class="stat-pill pill-blue">
              Datos registrados
            </div>
          </div>
          <div class="stat">
            <div class="stat-label">Fuentes h√≠dricas</div>
            <div class="stat-value">{{ resumen.total_fuentes }}</div>
            <div class="stat-pill pill-amber">
              Embalses, pozos, etc.
            </div>
          </div>
          <div class="stat">
            <div class="stat-label">Avance promedio</div>
            <div class="stat-value">{{ resumen.promedio_avance }}%</div>
            <div class="stat-pill pill-green">
              Avance global
            </div>
          </div>
        </div>

        <div class="tables">
          <div>
            <h2><span class="icon">üìå</span> Medidas recientes</h2>
            <table>
              <thead>
                <tr>
                  <th>Medida</th>
                  <th>Regi√≥n</th>
                  <th>Fuente</th>
                  <th>Avance</th>
                </tr>
              </thead>
              <tbody>
                {% for m in medidas %}
                  <tr>
                    <td>
                      <strong>{{ m.nombre }}</strong><br>
                      <span style="font-size:11px; color:var(--muted)">{{ m.objetivo|truncatechars:60 }}</span>
                    </td>
                    <td>{{ m.region }}</td>
                    <td><span class="tag">{{ m.fuente }}</span></td>
                    <td>{{ m.avance_pct }}%</td>
                  </tr>
                {% empty %}
                  <tr><td colspan="4">No hay medidas registradas.</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          <div>
            <h2><span class="icon">üìà</span> Indicadores recientes</h2>
            <table>
              <thead>
                <tr>
                  <th>Fecha</th>
                  <th>Medida</th>
                  <th>Volumen</th>
                  <th>Avance ecosist.</th>
                </tr>
              </thead>
              <tbody>
                {% for i in indicadores %}
                  <tr>
                    <td>{{ i.fecha }}</td>
                    <td>{{ i.medida.nombre }}</td>
                    <td>{{ i.volumen_reutilizado_m3d }} m¬≥/d</td>
                    <td>{{ i.caudal_ecologico_pct }}%</td>
                  </tr>
                {% empty %}
                  <tr><td colspan="4">No hay indicadores registrados.</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Columna derecha: clima + info -->
      <aside class="card">
        <div class="clima-card">
          <h2>
            <span class="icon">üå¶Ô∏è</span>
            Clima actual (API externa)
          </h2>
          <small>Datos obtenidos en tiempo real desde un servicio externo seg√∫n latitud/longitud.</small>

          <form method="get" class="clima-form">
            <input type="text" name="lat" value="{{ lat }}" placeholder="Latitud (ej: -33.45)" />
            <input type="text" name="lon" value="{{ lon }}" placeholder="Longitud (ej: -70.66)" />
            <button type="submit">Actualizar</button>
          </form>

          {% if clima_error %}
            <div class="alert">{{ clima_error }}</div>
          {% endif %}

          {% if clima %}
            <div class="clima-main">
              <div>
                <div class="clima-temp">
                  {{ clima.temperatura_c }}¬∞C
                </div>
                <div class="clima-meta">
                  Lat: {{ clima.lat }} ¬∑ Lon: {{ clima.lon }}<br>
                  Actualizado: {{ clima.hora }}
                </div>
              </div>
              <div style="font-size:48px">üíß</div>
            </div>

            <div class="clima-grid">
              <div class="clima-chip">
                <span>Viento</span>
                <span>{{ clima.viento_kmh }} km/h</span>
              </div>
              <div class="clima-chip">
                <span>Direcci√≥n</span>
                <span>{{ clima.direccion_viento }}¬∞</span>
              </div>
              <div class="clima-chip">
                <span>C√≥digo clima</span>
                <span>#{{ clima.codigo }}</span>
              </div>
              <div class="clima-chip">
                <span>Contexto</span>
                <span>Sequ√≠a / gesti√≥n h√≠drica</span>
              </div>
            </div>
          {% else %}
            {% if not clima_error %}
              <div class="clima-meta" style="margin-top:8px;">
                No se carg√≥ informaci√≥n de clima a√∫n. Prueba actualizar con coordenadas v√°lidas.
              </div>
            {% endif %}
          {% endif %}

          <hr style="margin:12px 0; border-color:var(--stroke);" />

          <div style="font-size:12px; color:var(--muted);">
            Este panel integra:
            <ul style="margin-top:6px; padding-left:16px;">
              <li>Autenticaci√≥n y control de sesi√≥n.</li>
              <li>CRUD de medidas, fuentes e indicadores.</li>
              <li>Consumo de API externa para contexto clim√°tico.</li>
              <li>Visualizaci√≥n de datos clave para la sequ√≠a.</li>
            </ul>
          </div>
        </div>
      </aside>
    </div>
  </div>
</body>
</html>
